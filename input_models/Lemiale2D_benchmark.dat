# 2D Lemiale benchmark, with a setup that is similar to what was used 
# in   Kaus          (2009, in press), Tectonophysics
# and  Lemiale et al (2008          ), PEPI 
#
# it consists of a single inclusion with specified lengthscale, subjected to compression 
# or extension

# Define number of elements in x,y & z-direction @ coarsest level (should be uneven!)
nnode_x					=	25    
#nnode_y				= 	15   
nnode_y					= 	9   
nnode_z					= 	15			
levels					= 	2			# number of multigrid levels

# Geometry
DimensionalUnits		=	1			# Dimensionless (=0) or SI-dimensional units (=1)?
L						=	40e3		# Length (y-direction)
W						=	40e3		# Width  (x-direction)
H						=	10e3		# Height (z-direction)
x_left					=	-20e3		# Left side of domain
y_front					=	-20e3		# Front side of domain
z_bot					=	0			# Bottom of box

# Define model setup and noise
Setup.Model				=	3			# 8-heterogeneity with specified lengthscales, 3-from file
ampl2D					=	0.0	 		# Amplitude of 2D sinuoidal perturbtion
ampl3D					=	0.0			# Amplitude of 3D sinuoidal perturbtion
amplNoise				=	0.0	 		# Amplitude of noise @ interface

# Define input/output and numerics-related stuff
OutputFile				=	Lemiale_Output		
save_timesteps			=	1			# save every ? timesteps
time_end				=	50			# last timestep
CFL						=	1			# CFL, dt-based criterium
dt_max					=	30e5	  	# Maximum timestep [years if dimensional]
	
# Boundary conditions
BC.Eyy					=	0e-15		# BG strainrate in y-direction
BC.Exx					=	-1e-15		# BG Strainrate in x-direction
BC.LeftBound			=	1			# 0 - free surface, 1-free slip with BG strainrate Eyy, 2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D 
BC.RightBound			=	1			# 0 - free surface, 1-free slip with BG strainrate Eyy, 2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
BC.FrontBound			=	1			# 0 - free surface, 1-free slip with BG strainrate Exx, 2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
BC.BackBound			=	1			# 0 - free surface, 1-free slip with BG strainrate Exx, 2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
BC.LowerBound			=	1			# 0 - free surface, 1-free slip, 				  2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
BC.UpperBound			=	0			# 0 - free surface, 1-free slip, 				  2 - no slip, 5 - growthrate 2D, 7 - growthrate 3D
Temp_top	    		=   0			# Temperature @ top
Temp_bottom				=   1000 		# Temperature @ bottom; side BC's are flux-free

# Grid advection method
GridAdvectionMethod		= 	2 				# 0-Fully Eulerian, 1-Fully Lagrangian, 2-ALE with remeshing @ surface layer
FactorSurfaceLayer		= 	1 				# How thick is the surface layer (if option 2 is selected above) ?

# Define solver and set options for Uzawa
SolverType					=	5			# 1-Multigrid, 2-KSP, 3-Direct [serial!], 4-MUMPS, 5-GMG
UzawaSolver 				=	1			# 1-Schur/FGMRES;  2-Old way (CG);  3-Powell Hesteness iterations
MG_Solver					=	1			# 0-default, 1-richa/bjac, 2-richa/jac, 3-richa/sor
MG_Scale					=	0.6			# Scale employed if MS_solver==1,2 or 3
SmoothUp					=   2           # Number of smoothing steps on finest level
SmootherMethod      		=   0           # 0-keep as in fine level, 1-increase steps on coarser levels 
MaximumDivergence  			=   1e-6        # Cutoff divergence
Uzawa_RelInnerAccuracy		=   1e-6        # Cutoff inner error for preconditioning step in Uzawa iterations
Uzawa_MaxInnerIterations	=   200			# Maximum number of inner iterations
NonlinearIterationsAccuracy	= 	1e-3		# Stopping criterium for power-law loop
MaxNonlinearIterations		= 	25			# Maximum number of nonlinear iterations


<PetscOptionsStart>
	# Fine-tune solver options here (add command-line Petsc Options)
	#-vpt_element Q2Pm1_global				# Type of element [Q2Pm1_global; Q2Pm1_local; Q1P0]
	-vpt_element Q1Q1						# Type of element [Q2Pm1_global; Q2Pm1_local; Q1P0]
	
	
	# specify the coordinates and location of the heterogeneity
	-Heterogeneity_x_start  -18e2
	-Heterogeneity_x_end 	 18e2
	-Heterogeneity_y_start  -20e3
	-Heterogeneity_y_end     20e3
	-Heterogeneity_z_start   0
	-Heterogeneity_z_end     18e2
	
	-AddRandomNoiseParticles 1
	
	# Stuff related to PH iterations
	-ph_kappa 1e8
	
	
	# Schur complement solver options:
	-schur_ksp_type 					fgmres
	-schur_ksp_monitor
	-schur_ksp_converged_reason
	-schur_pc_type 						jacobi

	-schur_ksp_atol						1.0e-8
	-schur_ksp_rtol						1.0e-2

	# use direct solver with SCR:
	#-schur_pc_type 						ml


	# general GMG stuff:
	-gmg_ksp_atol 1e-16
	-gmg_ksp_converged_reason
	

	# lightweight
	#-gmg_mg_levels_ksp_type 	richardson
	#-gmg_mg_levels_ksp_max_it 	2
	#-gmg_mg_levels_pc_type 		sor
	#-gmg_mg_levels_pc_sor_its	4
	#-gmg_mg_coarse_ksp_type		preonly
	#-gmg_mg_coarse_pc_type		lu
	
	# intermediate
	-gmg_mg_levels_ksp_type 	fgmres
	-gmg_mg_levels_ksp_max_it 	10
	-gmg_mg_levels_pc_type 		sor
	-gmg_mg_levels_pc_sor_its	4
	-gmg_mg_coarse_ksp_type		richardson
	-gmg_mg_coarse_pc_type		sor
	-gmg_mg_coarse_pc_sor_its	4
	-gmg_ksp_rtol 				1e-3		#relaxed solve
	

	# powerfull, yet somewhat expensive GMG options:
	#-gmg_ksp_atol 1e-16
	#-gmg_ksp_converged_reason
	#-gmg_mg_levels_ksp_type 	fgmres
	#-gmg_mg_levels_ksp_max_it	5
	#-gmg_mg_levels_ksp_rtol 	1e-3
	
	
	#-gmg_mg_levels_ksp_type		richardson
	#-gmg_mg_levels_pc_type		sor
	#-gmg_mg_levels_pc_sor_its	4
	
	
	#-gmg_mg_levels_pc_type 		bjacobi
	
	
	
	
	# --- Use fieldsplit at all levels ----
	#-gmg_mg_levels_pc_type fieldsplit
	#-gmg_mg_levels_pc_fieldsplit_block_size 3
	#-gmg_mg_levels_fieldsplit_ksp_type richardson
	#-gmg_mg_levels_fieldsplit_pc_type sor
	
	
	
	#-gmg_mg_levels_pc_type fieldsplit
	#-gmg_mg_levels_pc_fieldsplit_block_size 3
	#-gmg_mg_levels_fieldsplit_ksp_type fgmres
	#-gmg_mg_levels_fieldsplit_ksp_max_it 3
	#-gmg_mg_levels_fieldsplit_pc_type bjacobi
	#-gmg_mg_levels_fieldsplit_sub_pc_type icc
	
	#-gmg_mg_levels_pc_type ml

	
<PetscOptionsEnd>

# Phase distribution
ParticleInp 			=   1											# Use particles to track properties? 0-no; 1-yes
#ParticleFilename		=   ExtensionSetup_OneThroughgoing.dat			# File that contains particle distribution
ParticleFilename		=   ExtensionSetup_HalfThroughgoing.dat			# File that contains particle distribution
#ParticleFilename		=   ExtensionSetup_TwoQuarterThroughgoing.dat	# File that contains particle distribution
SaveTracers 			=   0                 	# Write particles to disk?
NumPartX				=	3					# Particles/Cell in x-direction
NumPartY				=	3					# Particles/Cell in y-direction
NumPartZ				=	3					# Particles/Cell in z-direction

# Read initial grid from file?
InitialMeshFromFile 	=   0					# In case you want to hand-modify the initial grid
InitialMeshFileName 	=   Grid_in.dat			# Make sure the size of this grid matches! 
InitialMantleLevel		=	0					# Set to zero to deactivate

# Properties that are defined over the whole domain:
Gravity					=	10;						# [m/s2] - gravitational acceleration 
PlasticityModel			=	0;						#  not implemented yet
Xi						=	0;						# [ ] - Shear heating factor - not implemented yet

# Define characteristic values, used if DimensionalUnits==1, otherwise ignored
Characteristic.Length			=	10e3			# [m]
Characteristic.Viscosity 		=	1e20			# [Pa.s]
Characteristic.Temperature		=	1				# [K]
Characteristic.Stress      		=   1e5				# [Pa]

# Define phase transitions for particles
num_phase_transitions			=	0				# The number of phase transitions present

# Define material properties for all phases -------------------------------------------------
num_phases					=	2		# Total number of phases defined in code
LowerViscosityCutoff		=	1e19;
UpperViscosityCutoff		=	1e25;


	# Define properties of inclusion----------------
	<MaterialStart>
		phase_id 			=	1
		attribute 			= 	VISCOSITY
		type 				= 	constant
		eta0       			= 	1e20	
	<MaterialEnd>
	<MaterialStart>
		phase_id			= 	1
		attribute 			= 	ELASTICITY
		type 				= 	constant
		shear        		= 	5e100
	<MaterialEnd>
	<MaterialStart>
		phase_id						= 	0
		attribute 						= 	PLASTICITY
		type 							= 	DruckerPrager
		Cohesion        				= 	40e6
		CohesionAfterWeakening			=	5e6
		FrictionAngle					= 	30
		FrictionAngleAfterWeakening 	=	20
		Weakening_PlasticStrain_Begin	=	0
		Weakening_PlasticStrain_End		=	0.5
	<MaterialEnd>
	
	<MaterialStart>
		phase_id			= 	1
		attribute 			= 	DENSITY
		type 				= 	temperature_dependent
		rho0        		= 	2700
		alpha 				=	0
	<MaterialEnd>
	<MaterialStart>
		phase_id			= 	1
		attribute 			= 	ENERGY
		type 				= 	constant
		ThermalConductivity	= 	3
		HeatCapacity		=	1050
		RadioactiveHeat		=	0
		ShearHeating		=	0
	<MaterialEnd>

	# Define properties of matrix -----------------
	<MaterialStart>
		phase_id 			=	0
		attribute 			= 	VISCOSITY
		type 				= 	constant 					
		eta0       			= 	1e26	
	<MaterialEnd>
	<MaterialStart>
		phase_id			= 	0
		attribute 			= 	ELASTICITY
		type 				= 	constant
		shear        		= 	5e100
	<MaterialEnd>
	<MaterialStart>
		phase_id						= 	0
		attribute 						= 	PLASTICITY
		type 							= 	DruckerPrager
		Cohesion        				= 	40e6
		CohesionAfterWeakening			=	5e6
		FrictionAngle					= 	30
		FrictionAngleAfterWeakening 	=	20
		Weakening_PlasticStrain_Begin	=	0
		Weakening_PlasticStrain_End		=	0.5
	<MaterialEnd>
	<MaterialStart>
		phase_id 			= 	0
		attribute 			= 	DENSITY
		type 				= 	temperature_dependent
		rho0        		= 	2700
		alpha 				=	0
	<MaterialEnd>
	<MaterialStart>
		phase_id			= 	0
		attribute 			= 	ENERGY
		type 				= 	constant
		ThermalConductivity	= 	3
		HeatCapacity		=	1050
		RadioactiveHeat		=	0
		ShearHeating		=	0
	<MaterialEnd>

# End of defining material properties for all phases ----------------------------------------