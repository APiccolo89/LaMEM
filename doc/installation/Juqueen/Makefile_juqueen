#====================================================
#
# Makefile for LaMEM
# developed by Boris Kaus & Dave May
#              Swiss Federal Institute of Technology
#			   CH-8050, Zurich
#              Switzerland
#
# Revision by Anton Popov
# Revision by Tobias Baumann
#
# NOTE: See Makefile.in for platform dependant definitions
#
#====================================================

# Include platform-specific constants

include Makefile.in

#====================================================

# Include PETSc files

include ${PETSC_DIR}/conf/variables
include ${PETSC_DIR}/conf/rules

#====================================================

# Define list of LAMEM library source files

CSRC = \
	LaMEMLib.c \
	LaMEMLib_FDSTAG.c \
	LaMEMLib_FDSTAG_private.c \
	LaMEM_Particles.c \
	LaMEM_Temperature.c \
	StokesOperators.c \
	Elements.c \
	Quadrature.c \
	Solvers.c \
	Breakpoint.c \
	Output.c \
	ParaViewOutput.c \
	NonDimensionalisation.c \
	Material.c \
	Mesh.c \
	Assembly.c \
	Assembly_FDSTAG.c \
	Utils.c \
	Parsing.c \
	Attributes.c \
	LaMEMVelPressureDA.c \
	LaMEMVelPressureDA_Q2PM1.c \
	LaMEMVelPressureDA_Q1P0.c \
	LaMEMVelPressureDA_Q1Q1.c \
	LaMEMVelPressureDA_FDSTAG.c \
	LaMEM_Initialize.c \
	LaMEM_AnalyticalSolutions.c \
	ApplyBoundaryConditions.c \
	AVDPhaseViewer.c \
	GetGravityField.c \
	GetSurfaceVelocity.c \
	LaMEM_FE_ErosionCode.c \
	Addition_FDSTAG.c \
	fdstag/fdstag.c \
	fdstag/lsolve.c \
	fdstag/nlsolve.c \
	fdstag/paraViewOutBin.c \
	fdstag/advect.c \
	fdstag/constEq.c \
	fdstag/dfzero.c \
	fdstag/JacRes.c \
	fdstag/interface.c \
	fdstag/interpolate.c \
	fdstag/outFunct.c \
	fdstag/scaling.c \
	fdstag/check_fdstag.c
   
#====================================================

# Generate lists of object files
	
COBJ := $(CSRC:.c=.o)

#====================================================

# Default task (build everything)

all : version liblamem.a LaMEM

#====================================================

# Include global SVN ID to the Code

version:
ifeq "$(SVN_AVAILABLE)" "yes"
	@echo "............................................."
	@echo ".... Program under svn version control ......"
	@echo "............................................."
	rm -f Version.h
	../scripts/revision.sh 1
	@echo "-> created Version.h"
else
	@echo "............................................."
	@echo "..... NO svn version control available ......"
	@echo "............................................."
	rm -f Version.h
	../scripts/revision.sh 0
	@echo "-> created Version.h"
endif


#====================================================

# Build LaMEM library

liblamem.a : ${COBJ}
	@echo "............................................."
	@echo ".......... Building LaMEM Library ..........."
	@echo "............................................."
	ar cr liblamem.a ${COBJ}
	ranlib liblamem.a
	cp -f liblamem.a ../lib
	
#====================================================

# Link LaMEM executable

LaMEM : version liblamem.a LaMEM.o
	@echo "............................................."
	@echo "......... Linking LaMEM Executable .........."
	@echo "............................................."
	${CLINKER} -o LaMEM LaMEM.o liblamem.a ${PETSC_LIB}
	cp -f LaMEM ../bin
	cp -f LaMEM ../bin/opt
#====================================================

# Pattern rule for object file generation

%.o : %.c LaMEM.h
	${PCC} ${PCC_FLAGS} ${CFLAGS} ${CCPPFLAGS} ${WRN_FLAGS} ${OPT_FLAGS} ${LAMEM_FLAGS} ${LAMEM_INCS} -c $< -o $@ 
#	${PCXX} ${PCC_FLAGS} ${CFLAGS} ${CCPPFLAGS} ${WRN_FLAGS} ${OPT_FLAGS} ${LAMEM_FLAGS} ${LAMEM_INCS} -c $< -o $@ 

#====================================================

clean_all :
	@echo "............................................."
	@echo "........... Cleaning Object Files ..........."
	@echo "............................................."
	rm -f *.o ./fdstag/*.o
	@echo "............................................."
	@echo ".......... Cleaning LaMEM Library ..........."
	@echo "............................................."
	rm -f liblamem.a ../lib/liblamem.a
	@echo "............................................."
	@echo "........ Cleaning LaMEM Executable .........."
	@echo "............................................."
	rm -f LaMEM ../bin/LaMEM
	rm -f LaMEM ../bin/opt/LaMEM
#====================================================

# Create automatic documentation

doc:
	PDFLATEX=$(PDFLATEX) BIBTEX=$(BIBTEX) ../doc/Manual/./CreateDevelDoc.sh